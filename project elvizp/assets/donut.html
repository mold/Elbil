<!DOCTYPE html>
<html>
  <style>
  form {
  position: absolute;
  right: 10px;
  top: 10px;
}

.inside {
    font-family: 'Roboto Condensed', sans-serif;
font-weight:900;
    font-size:72px;
    fill: rgba(0, 0, 0, 1);
}

.data {
    font-size:22px;
    color:#ffffff;
}

.arc {
  stroke: #fff;

}
  </style>
<body>


  
 <button onclick="myFunction()">Simulate</button>
<script src="evenergy.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
var lines, valueLabels, nameLabels;

vehicle = {
  cd:0.29,
  cr:0.012,
  area:2.7435,
  mass:1521
}

var vizData = [];
var totEnergy = 0;
  vizData = [
    {
    "eater": "acceleration",
    "energy": 0.06
    }, {
    "eater": "speed",
    "energy": 0.01
    }, {
    "eater": "climate",
    "energy": 0.01
    }];
evenergy.config(vehicle)

function requestLoop(){
  carData = JSON.parse(CarData.toJson());
  vizData = [];
  totEnergy = 0;

  evenergy.speed(carData.speed,"kmh").soc(carData.soc).acceleration(carData.acceleration).time(500,"ms");
  e = evenergy.kWhPerKm();
  if(e !== undefined && e !== NaN){
    vizData[0] = {eater: "acceleration", energy: e};
    totEnergy += e;
    console.log("acc: "+e);
  }else{
    return;
  }

  evenergy.acceleration(0);
  e = evenergy.kWhPerKm();
  if(e !== undefined && e !== NaN){
    vizData[1] ={eater: "speed", energy: e};
    totEnergy += e;
    console.log("speed: "+e);
  }else{
    return;
  }
  carData.climate = carData.climate ===  undefined || carData.climate < 0 || carData.climate === NaN ? 0.1 : carData.climate;
  totEnergy += carData.climate;
  console.log("climate: "+carData.climate);
  console.log("tot: "+totEnergy);
  vizData[2] = {eater: "climate", energy: carData.climate};

  change(vizData);
}

var width = 840,
    height = 600,
    radius = Math.min(width, height) / 2;

var color = d3.scale.ordinal()
    .range([d3.rgb(0.5,0.15,0.15), d3.rgb(0.15,0.5,0.15), d3.rgb(0.15,0.15,0.5)]);

var circleColor = "green";

var pie = d3.layout.pie()
    .sort(null)
  // .startAngle(-Math.PI/2)
  //.endAngle(Math.PI/2)
  .value(function(d) {
        return d.energy;
    });

var arc = d3.svg.arc()
    .innerRadius(radius - 200)
    .outerRadius(radius - 100);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

var path = svg.selectAll("path")
    .data(pie(vizData))
    .enter()
    .append("path")
     .attr("class", "arc")
    .attr("fill", function(d, i) { return color(i); })
    .attr("d", arc);
  
    svg.append("circle")
    .attr("cx", 0)
    .attr("cy", 0)
    .attr("r", 130)
    .attr("fill", "green")
    .attr("opacity", "0.2");


svg.append("text")
      .attr("dy", ".35em")
      .style("text-anchor", "middle")
      .attr("class", "inside")
      .text(function(d) { return totEnergy; });

svg.append("text")
       .attr("dy", "2em")
      .style("text-anchor", "middle")
      .attr("class", "data")
      .text(function(d) { return 'kWh/km'; });

path.transition()
    .duration(500)
    .attr("fill", function(d, i) {
        return color(i);
    })
    .attr("d", arc)
    .each(function(d) {
        this._current = d;
    }); // store the initial angles


window.setInterval(requestLoop, 500);


function change(data) {
    path.data(pie(data));
    path.transition().duration(750).attrTween("d", arcTween); // redraw the arcs
    
    svg.select(".arc")
      .attr("d", arc);

    svg.select(".inside")
      .text(function(d) { return Math.round(totEnergy*100)/100; });
}

// Store the displayed angles in _current.
// Then, interpolate from _current to the new angles.
// During the transition, _current is updated in-place by d3.interpolate.

function arcTween(a) {
    var i = d3.interpolate(this._current, a);
    this._current = i(0);
    return function(t) {
        return arc(i(t));
    };
}
  
  var d = 1;
  
function myFunction() {
    setInterval(function(){
     var circRad;
     if(d == 1){
       circRad = 135;
         change(data2);
      svg.select("circle")
      .attr("r", 135)
      .attr("opacity", "0.3")
    .attr("fill", "green");
          svg.select("text")
       .text(function(d) { return '0.09'; });
     }
       if(d == 2){
         circRad = 110;
         change(data3);
       svg.select("circle")
      .attr("r", 110)
      .attr("opacity", "0.2")
    .attr("fill", "green");
          svg.select("text")
       .text(function(d) { return '0.09'; });
     }
     if(d == 3){
       circRad = 140;
         change(data4);
    svg.select("circle")
      .attr("r", 140)
      .attr("opacity", "0.3")
    .attr("fill", "red");
         svg.select("text")
       .text(function(d) { return '0.14'; });
          }
      if(d == 4){
        circRad = 130;
         change(data1);        
              svg.select("circle")
              .attr("r", 130)
                .attr("opacity", "0.2")
    .attr("fill", "green");
  
        
        svg.select("text")
       .text(function(d) { return '0.08'; });
        d = 0;
      }
  d ++;
               arc
           .innerRadius(circRad)
           .outerRadius(radius);
         svg.select(".arc")
           .attr("d", arc);
      
    }, 1500);
 
  
}
  
  
</script>

</body>
</html>
